.. _processing-and-logic:

Processing and Logic
====================

Processing and Logic provides a programming environment to perform calculations, make decisions and take actions.

Some examples include:

- :ref:`Calculate average of multiple Parameters <example1>`
- :ref:`Transform a series using an equation <example2>`
- :ref:`Generate a series forecast to provide predictive alarming <example4>`

Programs are expressed as JavaScript, stored as configuration in Process Nodes, and executed on a schedule or as new data is acquired. Each program can interact with all Nodes in the current Workspace and any associated time-series data.

.. _process-nodes:

Process Nodes
-------------
There are two types of Nodes that can have a program defined as part of their configuration. The first is a Process Parameter that allows you to transform existing data; the second is a type of Data Source called a Processor that allows you to create new data values.



.. table::
    :class: table-fluid

    ======================   ==========================   ==================================
    \                        Process Parameter            Processor
    ======================   ==========================   ==================================
    **Node Type**            Parameter                    Data Source

    **Number of inputs**     3                            10

    **Number of outputs**    Single                       Multiple

    **Input scope**          Any Node in the Workspace    Any Node in the Workspace

    **Execution trigger**    On input update              On input update or schedule

    **Maximum Duration**     0.2 seconds                  2 seconds

    **Output timestamps**    Defined by first input       Defined by first input or schedule
    ======================   ==========================   ==================================

.. _process-parameter:

|icon-point-number-range-process| Process Parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A Process Parameter is a type of Parameter that has a program defined as part of it's configuration and can be created under any Data Source. The first input referred to by the program will be used to define the timestamps used by the output of the process. Each execution of the process must return a single output value of the expected type. This output can then be viewed in the same way as any other Parameter (for example, it can be shown as a table or chart, exported, used as input for a different process, etc.). The output can also have states defined which will trigger alarms.

Examples
________

.. _example1:

.. code-block:: javascript
    :linenos:

    // Calculate the average currentValue of Parameters from different Locations
    var param1 = NODE('Location 1/Source/Param');
    var param2 = NODE('Location 2/Source/Param');
    var param3 = NODE('Location 3/Source/Param');

    return (param1 + param2 + param3) / 3;

.. _example2:

.. code-block:: javascript
    :linenos:

    // Transform the currentValue of Param using a 3rd order polynomial
    var a = 7.24;
    var b = -10.004;
    var c = 4.328;
    var d = -0.4667;
    var v = NODE('Param').currentValue;

    return a + (b*v) + (c*v^2) + (d*v^3);

.. _processor:

|icon-datasource-processor| Processor
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A Processor is a type of Data Source containing a program that generates multiple output values, which are stored as new Parameters. The timestamps of the output data can be generated by scheduling the execution of the process, in the same way that data acquisition of a regular Data Source can be scheduled. Alternatively, the timestamps can be defined by the first input, just as with Process Parameters. 

Output Creation
_______________

Outputs are defined as part of your program and automatically created as Parameters under your Processor when the program is saved. To update a Processor output, use one of the four Node creation functions (NUMBER, TEXT, TIME or BOOLEAN) to obtain a reference to the output, then assign a value to a specific attribute, e.g. ``TEXT('output').currentValue = "Hello world";``.

.. raw:: latex

    \vspace{-10pt}

.. only:: not latex

    .. image:: processor-outputs.jpg
        :scale: 50 %
    | 

.. only:: latex
    
    | 

    .. image:: processor-outputs.jpg
        :scale: 100 %

Examples
________

.. _example3:

.. code-block:: javascript
    :linenos:

    // Assign values to multiple outputs
    var quotient = NODE('../Source/Param') / 5;
    var remainder = NODE('../Source/Param') % 5;

    NUMBER('quotient').currentValue = quotient;
    NUMBER('remainder').currentValue = remainder;

.. _example4:

.. code-block:: javascript
    :linenos:

    // Generate a series forecast to provide predictive alarming
    // Coming soon :)

.. _environment:

Environment
-----------

.. _global-variables:

Global Variables
~~~~~~~~~~~~~~~~

Global variables are references to Nodes that are related to the currently executing process in some way, and can be accessed using the following built-in keywords:

.. table::
    :class: table-fluid

    ======================   ============================================================
    **THIS**                 Currently executing :ref:`Process Node <process-nodes>`
    **SOURCE**               Data Source of currently executing process
    **LOCATION**             Location of currently executing process
    **WORKSPACE**            Workspace of currently executing process
    ======================   ============================================================

.. _global-functions:

Global Functions
~~~~~~~~~~~~~~~~

Global functions can be use to obtain a reference to a Node in your Workspace and are identified using an absolute or relative path argument.

.. table::
    :class: table-fluid

    =============================   ================================================
    **NODE(** *path* **)**          Retrieve node by path
    **NUMBER(** *path* **)**        Create or retrieve NUMBER Parameter by path
    **TEXT(** *path* **)**          Create or retrieve TEXT Parameter by path
    **TIME(** *path* **)**          Create or retrieve TIME Parameter by path
    **BOOLEAN(** *path* **)**       Create or retrieve BOOLEAN Parameter by path
    =============================   ================================================

.. _paths:

Paths
~~~~~

Paths are used as arguments in global functions to reference nodes or parameter values, and can be either absolute or relative. An absoute path is any path that starts with a foward slash. Any path that does not start with a foward slash is relative to the currently executing process. Standard UNIX style path syntax is used, so ``..`` refers to the parent in the Workspace tree.

.. table::
    :class: table-fluid

    =============================   ================================================================
    \                               Examples
    **Absolute**                    ``/Workspace/Location/Source/Parameter``

                                    ``/Workspace``

    **Relative**                    ``../Location 2/Source`` 

                                    ``../../Workspace`` 

                                    ``Parameter`` 
    =============================   ================================================================

.. _node-attributes-and-values:

Node Attributes and Values
~~~~~~~~~~~~~~~~~~~~~~~~~~

A Node reference can be used to access the attributes of that Node, including the data value if the Node is a Parameter. Attributes are accessed via dot notation, for example:

* ``LOCATION.name`` Name of the Location
* ``WORKSPACE.createdTime`` Creation time of the Workspace
* ``NUMBER("param1").offset`` Numeric offset of the Number Parameter
* ``NODE("param2").currentValue`` Current data value of the Parameter

A full reference of :ref:`Node attributes <api-resources-nodes>` is documented as part of the HTTP API.

.. _implicit-node-values:

Implicit Node Values
~~~~~~~~~~~~~~~~~~~~

Each type of Node reference can be used as an implicit value without using dot notation. For example, the implicit value field of a Parameter is ``currentValue``, so the Node reference can be used as a direct substitue for the current data value of the Node. This means the following two statements will return the same result:

Statement 1, access the current data value of a Node reference using dot notation, add 10 and return the result:

``return NODE("param1").currentValue + 10;``

Statement 2, access the current data value of a Node reference using the implicit Node value, add 10 and return the result:

``return NODE("param1") + 10;``

The above example is able to treat the Node reference for **param1** as if it were a number, because this Node is a Number Parameter. Note that the type of any specific Node is always the same regardless of how the Node is referenced. This means that using the global functions ``NUMBER("param1")`` and ``NODE("param1")`` will both return a Node reference of type Number Parameter, assuming **param1** is a Number. Use care when relying on implicit Node values, because the implicit value field and type is different for different types of Nodes. 


.. table::
    :class: table-fluid

    =============================   ========================  ====================
    Node Type                       Implicit value field      Implicit value type                       
    **Number Parameter**            ``currentValue``          Number
    **Text Parameter**              ``currentValue``          String
    **Time Parameter**              ``currentValue``          Time
    **Location**                    ``currentValue``          Array of [latitude,longitude] decimal values
    **Source**                      ``name``                  String
    **Folder**                      ``name``                  String
    **Workspace**                   ``name``                  String
    =============================   ========================  ====================


.. _shared-code:

Shared Functions
~~~~~~~~~~~~~~~~

Common processing routines can be defined as Shared Functions on the Processing tab of your Workspace configuration and accessed from any Process Node. Note that a Shared Function should not reference Global Variables or Global Functions.

.. _example5:

.. code-block:: javascript
    :linenos:

    // Convert Fahrenheit to Celsius
    function toCelsius( f ) 
    {
        return (5/9) * (f-32);
    }

Function Namespace
~~~~~~~~~~~~~~~~~~

Any functions that are called in the code of a Processor Sources and Process Parameters will be checked to see if they match any of the following:

1. :ref:`Global functions <global-functions>`
2. :ref:`User-defined shared functions <shared-code>`
3. `JavaScript built-in functions <https://www.w3schools.com/jsref/jsref_obj_global.asp>`_

If the function name is not found in any of these locations, this will result in a :ref:`validation error <validation-errors>`.


.. _process-alarm:

Process Alarm
-------------
A Process Alarm is raised when a process encounters an error during execution. A subsequent successful compilation or execution of the process will clear the alarm.


.. _errors:

Errors
------
The two general category of errors that can be encounted with Proccessing and Logic are compilation errors and runtime errors. 


.. _validation-errors:

Validation Errors
~~~~~~~~~~~~~~~~~~
Validation errors are caused either by incorrect syntax or some other error condition that can be detected. These errors are experienced as immediate feedback when validating a program, and contain a specific error message which can be used to remedy the problem. A program will not be executed until it can be validated without errors.

.. _runtime-errors:

Runtime Errors
~~~~~~~~~~~~~~
Runtime errors can occur during the execution of a program even when it validates successfully. For example, if an input node referenced by the program is deleted from the workspace, the program will no longer be able to run successfully. These types of errors will be expressed as process alarms, and will contain a specific error message to help remedy the problem. 

.. _best-practices:

Best Practices
--------------
- Inputs should be declared before they are referenced, so that any line numbers in error messages will clearly refer to the declaration of a missing input.
- Very complex or time-consuming calculations may cause the process to exceed the allowed processing time limit. 
- **Any** input that is referenced by a process will trigger execution of the process when that input is updated. Therefore, a large number of inputs being updated frequently or on different schedules can trigger a process to run very frequently. For example, if 9 inputs are updated every hour, but the 10th input is updated every minute, then the process will execute every minute.
- As the first referenced input is used to determine the output timestamp for a Process Parameter, the input which updates most frequently should be the first input.
- If the same algorithms are used repeatedly for different Process Nodes, this code should be expressed as a function and stored in the Workspace :ref:`Shared Code <shared-code>`.

.. only:: not latex

    |
